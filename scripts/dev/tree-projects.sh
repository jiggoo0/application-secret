#!/bin/bash

# ==============================================================================
# ðŸ› ï¸ JP-VISOUL-DOCS: Project Structure & Health Reporter
# ==============================================================================
# Description: Generates a comprehensive markdown report of the project structure.
# Features: Recursive directory mapping, dependency analysis, and pre-deploy sync.
# ==============================================================================

# âš™ï¸ CONFIGURATION
OUTPUT_FILE="project-structure.md"
PRE_DEPLOY_REPORT="pre-deploy-report.md"

# Directories allowed for scanning (Strictly aligned with Next.js 15 App Router)
WHITELIST_DIRS=(
  "app" 
  "actions" 
  "components" 
  "lib" 
  "hooks" 
  "types" 
  "scripts" 
  "public" 
  "data" 
  "constants" 
  "providers" 
  "content" 
  "styles" 
  "services" 
  "config"
)

# Regex to ignore non-essential or sensitive files
IGNORE_PATTERN="node_modules|\.git|\.next|\.DS_Store|__pycache__|\.env"

# ðŸš€ START EXECUTION
rm -f "$OUTPUT_FILE"

echo "ðŸ” Scanning JP-VISOUL-DOCS project architecture..."

{
  echo "# ðŸ“ Project Structure Report: JP-VISOUL-DOCS"
  echo "> Generated on: **$(date '+%Y-%m-%d %H:%M:%S')**"
  echo ""

  # --- 1. ARCHITECTURAL OVERVIEW ---
  echo "## ðŸŒ³ Directory Tree"
  echo "The following structure represents the core business logic and UI layers."
  echo ""

  for dir in "${WHITELIST_DIRS[@]}"; do
    if [ -d "$dir" ]; then
      echo "### ðŸ“‚ $dir"
      
      # Use find with depth calculation for visual rhythmic prose in tree form
      find "$dir" -maxdepth 10 -not -path '*/.*' | grep -vE "$IGNORE_PATTERN" | while read -r path; do
          
          # Indentation logic
          depth=$(temp="${path//[^\/]/}"; echo "${#temp}")
          indent=$(printf '%*s' $((depth * 2)) "")
          name=$(basename "$path")
          
          if [ -d "$path" ]; then
            # Directory entry (Skip the root dir of the loop itself)
            [[ "$path" != "$dir" ]] && echo "${indent}ðŸ“‚ **$name/**"
          else
            # File entry
            echo "${indent}ðŸ“„ $name"
          fi
      done
      echo ""
    fi
  done

  # --- 2. DEPENDENCY ANALYSIS ---
  echo "## ðŸ“¦ Project Dependencies"
  if [ -f "package.json" ]; then
    echo "Current configuration in \`package.json\`:"
    echo '```json'
    if command -v jq >/dev/null 2>&1; then
      # Displaying only vital production-ready information
      jq '{name, version, scripts, dependencies, devDependencies}' package.json
    else
      cat package.json
    fi
    echo '```'
  else
    echo "> âŒ Error: \`package.json\` not found in root directory."
  fi
  echo ""

  # --- 3. PRE-DEPLOYMENT HEALTH CHECK ---
  echo "## ðŸ“ Deployment Status & Issues"
  echo "---"
  
  if [ -f "$PRE_DEPLOY_REPORT" ]; then
    # 3.1 Status Verification
    if grep -qi "READY FOR DEPLOY" "$PRE_DEPLOY_REPORT"; then
      echo "### âœ… Final Status: **READY FOR DEPLOY**"
    else
      echo "### âŒ Final Status: **FIX REQUIRED**"
    fi
    echo ""

    # 3.2 Production Route Mapping
    if grep -q "### ðŸ“Š Route Statistics" "$PRE_DEPLOY_REPORT"; then
      echo "#### ðŸ“ Production Route Map"
      echo "\`\`\`text"
      sed -n '/### ðŸ“Š Route Statistics/,/---/p' "$PRE_DEPLOY_REPORT" | \
      grep -vE "###|---" | sed '/^$/d'
      echo "\`\`\`"
    fi

    # 3.3 Critical Issues Highlight
    echo "#### âš ï¸ Critical Issues Highlight"
    ERRORS=$(grep -E "âŒ|âš ï¸|[Ee]rror|[Ww]arning" "$PRE_DEPLOY_REPORT" | grep -v "###")
    if [ -z "$ERRORS" ]; then
      echo "Everything looks clean. No significant issues found in the latest report."
    else
      echo "$ERRORS"
    fi
  else
    echo "> â„¹ï¸ Pre-deploy report (\`$PRE_DEPLOY_REPORT\`) is missing. Please run \`npm run check\` first."
  fi

  echo ""
  echo "---"
  echo "_Report generated by JP-VISOUL Internal Automation._"

} > "$OUTPUT_FILE"

echo "âœ… Success: Report saved to â†’ $OUTPUT_FILE"
